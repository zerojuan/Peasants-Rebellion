define("GameView",["jquery","underscore","backbone","text!templates/game.html","text!templates/status-item.html","text!templates/move-item.html","text!templates/chat-item.html","text!templates/result-sidebar.html","text!templates/usurp-item.html","text!templates/announcement-item.html","text!templates/playerlist-item.html","GameModel","PlayChess"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p,d=p;return p=n.View.extend({initialize:function(n){var c=this;this.model=n,this.channel=this.model.get("code"),this.side=this.model.get("player").authId==null?"W":"B",this.playChess=new h({color:this.side,turn:this.model.get("turn")}),this.playChess.addMoveListener(this),this.template=t.template(r),this.chatTemplate=t.template(o),this.statusTemplate=t.template(i),this.moveTemplate=t.template(s),this.resultTemplate=t.template(u),this.usurpTemplate=t.template(a),this.announcementTemplate=t.template(f),this.playerListTemplate=t.template(l),xRTML.Config.debug=!1,this.ortcClient=null,this.model.get("alive")?xRTML.ready(function(){var t=xRTML.ConnectionManager.create({url:"http://ortc-developers.realtime.co/server/2.1/",id:"Peasant-Chess-Connection",appKey:"Qy9W72",authToken:"peasantchessauth",channels:[{name:"peasant_chess_browser_"+c.channel,onMessage:xRTML.Common.Function.proxy(function(e){var t=e.message;c._parseMessage(t)},this)}],onConnect:xRTML.Common.Function.proxy(function(t){console.log("Connected..."),e(".overlay").fadeOut(),e(".chat-box").prop("disabled",!1)},this),metadata:xRTML.JSON.stringify({player:c.model.get("player"),color:c.side,code:c.model.get("code")})})}):e(".overlay").fadeOut(),e("time").timeago()},events:{"keyup .chat-box":"onChatType","focus .chat-box":"onChatFocus","blur .chat-box":"onChatBlur","resize window":"onResizeWindow","click .player-name":"onClickPlayerName","click #back-btn":"onBackClicked","click #share-btn":"onShareClicked","click #help-btn":"onHelpClicked","click .move-feed":"onMoveFeedClicked","click .announcement-feed":"onClickPlayerName","click #share-panel .bg":"onHideSharePanel","click #help-panel":"onHideHelpPanel","click #results-panel":"onHideResultsPanel"},render:function(){var t=this,n,r=this.model.toJSON(),i="king";this.side=="W"&&(i="peasant");var n=this.template({color:i,game:r,side:this.side});e(t.el).html(n);var s=e(t.el).find("#gameboard")[0];return this.playChess.initialize(s,r,function(){t.updateTurn(t.model.get("turn"));var n=t.model.get("moves");r.alive?t.showMoves(n):(console.log("GAME IS DEAD!"),e(t.el).find(".overlay").hide(),t.showWinnerBG(r.winner),t.showResultSidebar(r.winner,n),t.playChess.showGameOver(r.winner))}),e(window).resize(function(){t._resizeScroller()}),this.initializePlayerList(),this},initializeAntiscroll:function(){this._resizeScroller()},initializePlayerList:function(){var e=this.model.get("king"),t={color:"B",player:e};this.createConnectionElement(t);var n=this.model.get("peasants");for(var r in n){var i=n[r];t={color:"W",player:i},this.createConnectionElement(t)}},_resizeScroller:function(){var t=e(this.el),n=t.find(".content-slider-wrapper").height(),r=t.find(".side-bar-header").height()+20;t.find(".antiscroll-inner").css("height",n-r+"px").css("width","290px"),this.scroller=t.find(".antiscroll-wrap").antiscroll().data("antiscroll")},onResizeWindow:function(){this._resizeScroller()},onTap:function(){e(".move-feed").removeClass("active")},onMoveFeedClicked:function(t){if(e(t.currentTarget).hasClass("active"))e(t.currentTarget).removeClass("active"),this.playChess.hideMove();else{e(".move-feed").removeClass("active"),e(t.currentTarget).addClass("active");var n=e(t.currentTarget).attr("id");this.playChess.showMove(n,this.model.get("moves"))}},onShareClicked:function(){e(this.el).find("#share-panel").css("top","-2000px").animate({top:"250px",bottom:"0"},600),e(this.el).find("#share-panel .bg").css("bottom","1000px").animate({bottom:"0"},600)},onHelpClicked:function(){e(this.el).find("#help-panel").css("top","-2000px").animate({top:"50px",bottom:"0"},600),e(this.el).find("#help-panel .bg").css("bottom","1000px").animate({bottom:"0"},600)},onHideSharePanel:function(){e(this.el).find("#share-panel").animate({top:"-2000px",bottom:"2000px"},600),e(this.el).find("#share-panel .bg").animate({bottom:"2000px"},600)},onHideHelpPanel:function(){e(this.el).find("#help-panel").animate({top:"-2000px",bottom:"2000px"},600),e(this.el).find("#help-panel .bg").animate({bottom:"2000px"},600)},onClickPlayerName:function(){e(this.el).find("#main-feed-slider").animate({marginLeft:"-320px"},300)},onBackClicked:function(){e(this.el).find("#main-feed-slider").animate({marginLeft:"0px"},300)},onChatBlur:function(){var t=e.trim(e(this.el).find(".chat-box").val());t===""&&(e(this.el).find(".chat-box").attr("placeholder","Say something..."),e(this.el).find(".chat-form").removeClass("expanded"),e(this.el).find(".chat-form").addClass("condensed"))},onHideResultsPanel:function(){e(this.el).find("#results-panel").animate({top:"-2000px",bottom:"2000px"},600),e(this.el).find("#results-panel .bg").animate({bottom:"2000px"},600)},showResultsPanel:function(t){t=="B"?e(this.el).find("#results-panel img").attr("src","./assets/king-win.png"):t=="W"?e(this.el).find("#results-panel img").attr("src","./assets/peasant-win.png"):(e(this.el).find("#results-panel img").attr("src","./assets/peasant-win.png"),e(this.el).find("#results-panel figcaption").html("Stalemate...")),this.showWinnerBG(t),e(this.el).find("#results-panel").css("top","-2000px").animate({top:"0",bottom:"0"},600),e(this.el).find("#results-panel .bg").css("bottom","1000px").animate({bottom:"0"},600)},showResultSidebar:function(t,n){var r="",i="";t=="B"?(r="king",i="The Monarch Endures!"):t=="W"?(r="peasant",i="The Rebellion has Succeeded!"):(r="draw",i="The War Dragged to a Stalemate");var s=this.resultTemplate({winner:r,message:i});e(this.el).find(".content-slider-item").html(s).hide().fadeIn(),this.showMoves(n),this._resizeScroller()},showMoves:function(e){for(var t in e){var n=e[t];this.createMoveElement(n)}},showWinnerBG:function(t){t=="B"?e(this.el).find(".winning-bg img").attr("src","./assets/king-shield-alpha.png"):t=="W"?e(this.el).find(".winning-bg img").attr("src","./assets/peasant-shield-alpha.png"):e(this.el).find(".winning-bg img").attr("src","./assets/draw-shield-alpha.png"),e(this.el).find(".winning-bg").css("left","-1000px").animate({left:"-250px"},600),e(this.el).find("#turn-wrapper").html(""),e("time").timeago()},onChatFocus:function(){e(this.el).find(".chat-box").attr("placeholder",'Type "!usurp <passkey> <newpasskey>" to usurp the king. Otherwise, type whatever.'),e(this.el).find(".chat-form").removeClass("condensed"),e(this.el).find(".chat-form").addClass("expanded")},onChatType:function(t){if(t.keyCode==13&&!t.shiftKey){var n=e(this.el).find(".chat-box"),r=e.trim(n.val());n.val(r);var i=(new Date).toISOString(),s={player:this.model.get("player"),message:r,timestamp:i};this._publishMessage("chat",s),n.attr("disabled","disabled")}return!1},onMove:function(e,t){this._publishMessage("move",{name:this.model.get("player").name,piece:e.type,color:e.color,from:{row:e.row,col:e.col},to:t})},onTouch:function(e){this._publishMessage("touch",{name:this.model.get("player").name,code:this.model.get("player").playerCode,piece:e.type,color:e.color,from:{row:e.row,col:e.col}})},_appendToFeed:function(t){e(t).hide().prependTo(e(this.el).find("#main-feed")).fadeIn("slow"),this.scroller&&this.scroller.refresh()},createConnectionElement:function(t){var n="king";t.color=="B"?n="king":n="peasant";var r=this.playerListTemplate({passkey:t.player.passkey,alive:t.player.alive,color:n,code:t.player.playerCode,name:t.player.name,title:t.player.title});e(this.el).find("#"+t.player.playerCode).fadeOut().remove(),t.color=="B"?e(r).hide().prependTo(e(this.el).find(".king-container")).fadeIn("slow"):(e(this.el).find(".peasant-container .sample").remove(),e(r).hide().prependTo(e(this.el).find(".peasant-container")).fadeIn("slow")),this.scroller&&this.scroller.refresh()},createDisconnectionElement:function(t){e(this.el).find("#"+t.player.playerCode).fadeOut().remove();if(t.color=="B"){e(this.el).find("#"+t.player.playerCode).fadeOut().remove();var n=this.playerListTemplate({passkey:t.player.passkey,alive:!1,color:"king",code:t.player.playerCode,name:t.player.name,title:t.player.title});e(n).hide().prependTo(e(this.el).find(".king-container")).fadeIn("slow")}else e(this.el).find(".peasant-container .feed-item").length==0&&(e(this.el).find(".peasant-container").html(""),e('<p class="sample">No one. Share this url to your friends (and enemies)!</p>').hide().appendTo(e(this.el).find(".peasant-container")).fadeIn("slow"))},createAnnouncementElement:function(t,n){var r=e.timeago(new Date),i="",s="king";n.color=="B"?s="king":s="peasant",t=="disconnect"?n.usurped?i=" the disgraced King has finally left.":n.color=="B"?i=" has left the throne! His passkey is rumored to be: "+n.player.passkey:i=" has left.":n.color=="B"?i=" is back!":i=" has joined the Rebels!";var o=this.announcementTemplate({type:t,color:n.color,name:n.player.name,timestamp:(new Date).toISOString(),timestring:r,message:i,status:s});this._appendToFeed(o)},createChatElement:function(t){var n=e.timeago(t.timestamp),r=this.chatTemplate({color:t.player.color,name:t.player.name,message:t.message,timestamp:t.timestamp,timestring:n});this._appendToFeed(r)},createStatusElement:function(t,n){var r=e.timeago(new Date);t&&(n=t.color+t.piece+" moved.",r=e.timeago(new Date));var i=this.statusTemplate({msg:n,timestamp:(new Date).toISOString(),timestring:r});this._appendToFeed(i)},createUsurpElement:function(t,n){var r=e.timeago(new Date),i=this.model.get("king").name,s=this.usurpTemplate({timestamp:(new Date).toISOString(),timestring:r,status:t,name:n.player.name,kingName:i});this._appendToFeed(s)},_getPieceData:function(e,t){var n="King";switch(e){case"K":t=="B"?n="King":n="Leader";break;case"Q":t=="B"?n="Queen":n="General";break;case"N":n="Knight";break;case"P":t=="B"?n="Pawn":n="Peasant"}return n},createMoveElement:function(t){var n=new Date(t.time),r=e.timeago(n),i="",s="King";s=this._getPieceData(t.piece,t.color),t.moveType!="promote"&&(t.moveType=="capture"?i=" capturing an enemy "+this._getPieceData(t.captured.charAt(1),t.captured.charAt(0)):t.moveType=="stalemate"?i=" leading the rebellion to a stalemate.":t.moveType=="checkmate"&&(i=" resulting to a checkmate."));var o=["a","b","c","d","e","f","g","h"],u=o[t.from.col]+""+(t.from.row+1),a=o[t.to.col]+""+(t.to.row+1),f=this.moveTemplate({data:t,result:i,from:u,to:a,piece:s,timestamp:n.toISOString(),timestring:r});this._appendToFeed(f)},updateColor:function(e){this.side=e,this.playChess.setColor(e)},updateBanner:function(t,n){console.log("Updating banner"),console.log("I should be the new king",n.player.name),t=="me"?(console.log("Updating banner"),e(".top").removeClass("peasant"),e(".top").addClass("king"),e(".top span.banner").hide().html("Peasants Revolt Against "+n.player.name).fadeIn()):t=="me-lose"?(console.log("I should be the new king",n.player.name),e(".top").removeClass("king"),e(".top").addClass("peasant"),e(".top span.banner").hide().html("Peasants Revolt Against "+n.player.name).fadeIn()):e(".top span.banner").hide().html("Peasants Revolt Against "+n.player.name).fadeIn()},updateTurn:function(t){var n=this.side=="W"?"Peasant":"King",r=this.side=="W"?"peasant":"king";console.log("Current Turn: "+t),this.model.set("turn",t),this.side==t?(this.side=="W"?e(this.el).find("#turn-wrapper").html("Our turn, Brother"):e(this.el).find("#turn-wrapper").html("Your turn, Your Highness"),e(this.el).find("canvas").addClass(r)):(this.side=="W"?n="the King's turn":n="the peasants' move",e(this.el).find("canvas").removeClass(r),e(this.el).find("#turn-wrapper").html("Waiting for "+n))},_parseMessage:function(t){var n=JSON.parse(t),r=n.data;try{switch(n.type){case"connection":console.log("Connected: "+r.player.name),this.createAnnouncementElement("connect",r),this.createConnectionElement(r);break;case"disconnection":console.log("Disconnected: "+r.player.name),this.createAnnouncementElement("disconnect",r),this.createDisconnectionElement(r);break;case"usurp":console.log("USURPATION!"),e(this.el).find(".chat-box").removeAttr("disabled"),r.success?(console.log("All Hail the new King"),this.model.get("player").playerCode==r.player.playerCode?(e.cookie(this.model.get("code")+".auth_king",r.player.authId),console.log("Loading cookie: "+e.cookie(this.model.get("code")+".auth_king")),this.updateColor("B"),this.updateBanner("me",r),this.updateTurn(this.model.get("turn")),this.createUsurpElement("success",r),this.model.set("king",r.player)):this.side=="B"?(console.log("Goodbye, former king!"),this.updateBanner("me-lose",r),this.createUsurpElement("success-me",r),this.playChess.showGameOver("D"),e(this.el).find("#turn-wrapper").html("You have been usurped...")):(this.updateBanner("default",r),this.createUsurpElement("success",r))):(console.log("failed attempt"),r.player.color=="B"?this.createUsurpElement("mad",r):this.createUsurpElement("failed",r));break;case"chat":console.log("CHAT:"),r.player.name==this.model.get("player").name&&(e(this.el).find(".chat-box").removeAttr("disabled"),e(this.el).find(".chat-box").val("")),this.createChatElement(r);break;case"touch":console.log("TOUCH:"),r.code!=this.model.get("player").playerCode&&this.playChess.onTouch(r);break;case"move":console.log("MOVE: "),console.log(r),this.model.get("moves").push(r),this.createMoveElement(r);if(r.moveType=="stalemate")console.log("Stalemate"),this.showResultsPanel("D"),d.playChess.showGameOver("D");else if(r.moveType=="checkmate"){console.log("Checkmate!");var i="";r.turn=="B"?i="W":i="B",this.showResultsPanel(i),this.playChess.updatePiece(r),this.playChess.showGameOver(i)}else this.updateTurn(r.turn),this.playChess.updatePiece(r)}}catch(s){throw console.error("OH MY GOD THIS EXCEPTION IS SUCKS!"),s}e("time").timeago()},_publishMessage:function(e,t){var n="peasant_chess_server_"+this.channel;console.log("Publishing to "+n);switch(e){case"connect":console.log("Connected");break;case"chat":var r={type:e,data:t},i=xRTML.MessageManager.create({trigger:"chat",action:"",data:r});xRTML.ConnectionManager.sendMessage({connections:["Peasant-Chess-Connection"],channel:n,content:i});break;case"touch":var r={type:e,data:t},i=xRTML.MessageManager.create({trigger:"touch",action:"",data:r});xRTML.ConnectionManager.sendMessage({connections:["Peasant-Chess-Connection"],channel:n,content:i});break;case"move":var r={type:e,data:t},i=xRTML.MessageManager.create({trigger:"move",action:"",data:r});xRTML.ConnectionManager.sendMessage({connections:["Peasant-Chess-Connection"],channel:n,content:i})}}}),p});